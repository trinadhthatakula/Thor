default_platform(:android)

platform :android do
  desc "Build and Distribute with Auto-Incremented Version Code"
  lane :distribute do

    # 0. SETUP CONTEXT
    app_id = CredentialsManager::AppfileConfig.try_fetch_value(:package_name)
    UI.message("ðŸš€ Starting Distribution for: #{app_id}")

    # 1. FETCH LATEST VERSION
    begin
      latest_version = google_play_track_version_codes(
        track: "internal"
      ).max
    rescue FastlaneCore::Interface::FastlaneError => ex
      UI.error("âš ï¸ Could not fetch version from Play Store: #{ex}")
      latest_version = 1709
    end

    new_version_code = (latest_version || 1709) + 1

    # ---------------------------------------------------------
    # 2. CALCULATE VERSION NAME (Via Gradle SSOT)
    # ---------------------------------------------------------
    UI.message("Run Gradle to calculate Version Name for Code: #{new_version_code}...")

    # We call the task we just created.
    # -q (quiet) suppresses Gradle logs so we only get the println output
    # -PversionCode passes the new number to Gradle
    new_version_name = sh("../gradlew -q app:printVersionName -PversionCode=#{new_version_code}").strip

    UI.message("âœ… Gradle returned Version Name: #{new_version_name}")

    # Write to file for GitHub Actions
    File.write("../version_name.txt", new_version_name)

    # ---------------------------------------------------------
    # 3. BUILD ARTIFACTS
    # ---------------------------------------------------------

    # Build Store AAB
    gradle(
      task: "bundleStoreRelease",
      properties: {
        "versionCode" => new_version_code
      }
    )

    generated_aab_path = lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]
    unless generated_aab_path
      UI.user_error!("âŒ Gradle failed to return an AAB path.")
    end

    # Build FOSS APK
    gradle(
      task: "copyFossReleaseApk",
      properties: {
        "versionCode" => new_version_code
      }
    )

    # ---------------------------------------------------------
    # 4. UPLOAD TO PLAY STORE
    # ---------------------------------------------------------
    upload_to_play_store(
      track: 'internal',
      release_status: 'completed',
      aab: generated_aab_path,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_apk: true
    )
  end
end