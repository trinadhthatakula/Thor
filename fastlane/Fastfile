default_platform(:android)

platform :android do
  desc "Build and Distribute with Auto-Incremented Version Code"
  lane :distribute do

    # ---------------------------------------------------------
    # 1. FETCH LATEST VERSION FROM GOOGLE PLAY
    # ---------------------------------------------------------
    # We check the 'internal' track. Change to 'production' if that is your baseline.
    begin
      latest_version = google_play_track_version_codes(
        track: "internal",
        package_name: "com.valhalla.thor",
        json_key: ENV["SUPPLY_JSON_KEY"]
      ).max
    rescue => ex
      UI.error("Could not fetch version from Play Store: #{ex}")
      # Fallback for fresh apps
      latest_version = 1709
    end

    new_version_code = (latest_version || 1709) + 1

    # ---------------------------------------------------------
    # 2. CALCULATE VERSION NAME (Must match Gradle logic)
    # Logic: 1710 -> 1.71.0
    # ---------------------------------------------------------
    major = new_version_code / 1000
    minor = (new_version_code % 1000) / 10
    patch = new_version_code % 10
    new_version_name = "#{major}.#{minor}.#{patch}"

    UI.message("ðŸš€ Preparing to build Version: #{new_version_name} (Code: #{new_version_code})")

    # CRITICAL: Write version name to a file so GitHub Actions can read it later
    File.write("../version_name.txt", new_version_name)

    # ---------------------------------------------------------
    # 3. BUILD ARTIFACTS (Injected with new version code)
    # ---------------------------------------------------------

    # Build Store AAB
    gradle(
      task: "bundleStoreRelease",
      properties: {
        "versionCode" => new_version_code
      }
    )

    # Build FOSS APK (Synced version)
    gradle(
      task: "assembleFossRelease copyFossReleaseApk",
      properties: {
        "versionCode" => new_version_code
      }
    )

    # ---------------------------------------------------------
    # 4. UPLOAD TO PLAY STORE
    # ---------------------------------------------------------
    upload_to_play_store(
      track: 'internal',
      release_status: 'completed', # 'completed' = immediate rollout to testers. Use 'draft' to manually review.
      aab: '../app/build/outputs/bundle/storeRelease/app-store-release.aab',
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_apk: true # We only upload AAB to Play Store
    )
  end
end