default_platform(:android)

platform :android do

  # --- HELPER: Common Build Logic ---
  # UPDATED: Now accepts 'track' to distinguish between Internal (Dev) and Alpha/Closed (Prod)
  def prepare_release_artifacts(upload_to_store: false, track: 'internal', version_code: nil)
    # 1. PREPARATION
    fastlane_dir = Dir.pwd
    project_root = File.expand_path("..", fastlane_dir)
    gradle_properties_path = File.join(project_root, "gradle.properties")

    # 2. CONFIGURATION & CHECKS
    UI.message("ðŸ“ Reading configuration...")
    unless File.exist?(gradle_properties_path)
      UI.user_error!("âŒ gradle.properties not found at #{gradle_properties_path}")
    end

    # Parse properties
    properties = File.readlines(gradle_properties_path)
                     .map(&:strip)
                     .reject { |l| l.empty? || l.start_with?('#') }
                     .map { |l| l.split('=', 2).map(&:strip) }
                     .to_h

    # 3. DETERMINE VERSION CODE
    final_version_code = nil

    if version_code
      final_version_code = version_code.to_i
      UI.important("âš ï¸  Using MANUAL version code override: #{final_version_code}")
    else
      final_version_code = properties["versionCode"]&.to_i
      UI.user_error!("âŒ 'versionCode' missing in gradle.properties") unless final_version_code
      UI.message("âœ… Using defined version code from properties: #{final_version_code}")
    end

    # 4. GET VERSION NAME
    new_version_name = ""
    Dir.chdir(project_root) do
      new_version_name = sh("./gradlew -q app:printVersionName -PversionCode=#{final_version_code}").strip
    end

    UI.message("ðŸ“¦ Build Target: v#{new_version_name} (#{final_version_code}) - Track: #{track}")

    # Save for GitHub Actions steps
    File.write(File.join(project_root, "version_name.txt"), new_version_name)
    File.write(File.join(project_root, "version_code.txt"), final_version_code.to_s)

    # 5. BUILD ARTIFACTS
    # We build APKs (for GitHub/Telegram) AND Bundle (for Play Store)
    build_tasks = "clean copyStoreReleaseApk copyFossReleaseApk"
    build_tasks += " bundleStoreRelease" if upload_to_store

    gradle(
      task: build_tasks,
      project_dir: project_root,
      properties: {
        "versionCode" => final_version_code,
        "android.injected.version.code" => final_version_code
      }
    )

    # 6. DEPLOY (Conditional)
    if upload_to_store
      generated_aab_path = lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]
      UI.user_error!("âŒ No AAB generated") unless generated_aab_path

      # Upload to specific track (internal or alpha/closed)
      upload_to_play_store(
        track: track,
        release_status: 'completed', # Draft or completed? usually completed for internal/alpha
        aab: generated_aab_path,
        skip_upload_metadata: true,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_apk: true
      )
      UI.success("ðŸš€ Deployed to Play Store [#{track}]!")
    else
      UI.success("ðŸ“¦ Artifacts built successfully (Upload skipped)")
    end
  end

  # --- LANES ---

  desc "Dev: Build -> Play Store (Internal) -> Telegram -> GitHub Pre-release"
  lane :distribute_dev do
    prepare_release_artifacts(upload_to_store: true, track: 'internal')
  end

  desc "Prod: Build -> Play Store (Closed/Alpha) -> GitHub Release"
  lane :distribute_production do
    # 'alpha' is the standard track key for "Closed Testing" in Google Play Console
    prepare_release_artifacts(upload_to_store: true, track: 'alpha')
  end

  # Helper for manual triggering
  desc "Build Release Candidates Only (No Store)"
  lane :build_release_candidates do |options|
    prepare_release_artifacts(
        upload_to_store: false,
        version_code: options[:version_code]
    )
  end
end