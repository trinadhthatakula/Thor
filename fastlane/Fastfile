default_platform(:android)

platform :android do

  # --- HELPER: Common Build Logic ---
  # Added 'version_code' and 'increment' arguments
  def prepare_release_artifacts(upload_to_store: false, version_code: nil, increment: true)
    # 1. PREPARATION
    fastlane_dir = Dir.pwd
    project_root = File.expand_path("..", fastlane_dir)
    gradle_properties_path = File.join(project_root, "gradle.properties")

    # 2. CONFIGURATION & CHECKS
    UI.message("ğŸ“ Reading configuration...")
    unless File.exist?(gradle_properties_path)
      UI.user_error!("âŒ gradle.properties not found at #{gradle_properties_path}")
    end

    properties = File.readlines(gradle_properties_path)
                     .map(&:strip)
                     .reject { |l| l.empty? || l.start_with?('#') }
                     .map { |l| l.split('=', 2).map(&:strip) }
                     .to_h

    initial_version_code = properties["initialVersionCode"]&.to_i
    UI.user_error!("âŒ 'initialVersionCode' missing") unless initial_version_code

    # 3. VERSION MANAGEMENT
    new_version_code = nil

    if version_code
      # A. Specific version passed manually
      new_version_code = version_code.to_i
      UI.message("ğŸ”§ Using manual specific version code: #{new_version_code}")
    else
      # B. Fetch from Store
      UI.message("ğŸ” Fetching latest version from Play Store (Internal Track)...")
      begin
        latest_store_codes = google_play_track_version_codes(track: "internal")
        latest_version_from_store = latest_store_codes.max
      rescue => ex
        UI.important("âš ï¸  Could not fetch version: #{ex.message}")
        latest_version_from_store = nil
      end

      if latest_version_from_store.nil?
        new_version_code = initial_version_code
        UI.message("ğŸ†• No existing Store version. Using initial: #{new_version_code}")
      else
        if increment
          # Auto-increment (Default for Production)
          new_version_code = [latest_version_from_store, initial_version_code].max + 1
          UI.message("â¬†ï¸  Incrementing version: #{latest_version_from_store} -> #{new_version_code}")
        else
          # Re-build existing (Default for Manual)
          new_version_code = latest_version_from_store
          UI.message("ğŸ”„ Re-building existing Store version: #{new_version_code}")
        end
      end
    end

    # 4. CALCULATE VERSION NAME
    new_version_name = ""
    Dir.chdir(project_root) do
      new_version_name = sh("./gradlew -q app:printVersionName -PversionCode=#{new_version_code}").strip
    end

    UI.message("âœ… Version Name: #{new_version_name}")
    File.write(File.join(project_root, "version_name.txt"), new_version_name)
    File.write(File.join(project_root, "version_code.txt"), new_version_code.to_s)

    # 5. BUILD ARTIFACTS
    build_tasks = "clean copyStoreReleaseApk copyFossReleaseApk"

    # Only build bundle if uploading or if we explicitly want it
    if upload_to_store
      build_tasks += " bundleStoreRelease"
    end

    gradle(
      task: build_tasks,
      project_dir: project_root,
      properties: {
        "versionCode" => new_version_code,
        "android.injected.version.code" => new_version_code
      }
    )

    # 6. DEPLOY (Conditional)
    if upload_to_store
      generated_aab_path = lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]
      UI.user_error!("âŒ No AAB generated") unless generated_aab_path

      upload_to_play_store(
        track: 'internal',
        release_status: 'completed',
        aab: generated_aab_path,
        skip_upload_metadata: true,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_apk: true
      )
      UI.success("ğŸš€ Deployed to Play Store!")
    else
      UI.success("ğŸ“¦ Artifacts built successfully (Upload skipped)")
    end
  end

  desc "Build and Distribute to Play Store + GitHub"
  lane :distribute do
    # Production always auto-increments
    prepare_release_artifacts(upload_to_store: true, increment: true)
  end

  desc "Build Release Candidates Only (No Play Store Upload)"
  lane :build_release_candidates do |options|
    # Manual builds default to NOT incrementing, unless specific logic applies
    # Inputs come as strings from CLI
    specific_code = options[:version_code]
    should_inc = options[:increment] == "true"

    prepare_release_artifacts(
        upload_to_store: false,
        version_code: specific_code,
        increment: should_inc
    )
  end

end