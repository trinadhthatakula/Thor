default_platform(:android)

platform :android do
  desc "Build and Distribute with Auto-Incremented Version Code"
  lane :distribute do

    # ---------------------------------------------------------
    # 0. SETUP CONTEXT
    # ---------------------------------------------------------
    app_id = CredentialsManager::AppfileConfig.try_fetch_value(:package_name)
    UI.message("ðŸš€ Starting Distribution for: #{app_id}")

    # ---------------------------------------------------------
    # 1. FETCH LATEST VERSION
    # ---------------------------------------------------------
    begin
      # Fastlane automatically pulls package_name and json_key from Appfile
      latest_version = google_play_track_version_codes(
        track: "internal"
      ).max
    rescue FastlaneCore::Interface::FastlaneError => ex
      # Only catch specific Fastlane errors (e.g., track not found, first run)
      UI.error("âš ï¸ Could not fetch version from Play Store: #{ex}")
      # Fallback if the app is brand new
      latest_version = 1709
    end

    new_version_code = (latest_version || 1709) + 1

    # ---------------------------------------------------------
    # 2. CALCULATE VERSION NAME
    # ---------------------------------------------------------
    major = new_version_code / 1000
    minor = (new_version_code % 1000) / 10
    patch = new_version_code % 10
    new_version_name = "#{major}.#{minor}.#{patch}"

    UI.message("ðŸ”¨ Building Version: #{new_version_name} (Code: #{new_version_code})")

    # CRITICAL: Write version name to a file so GitHub Actions can read it
    File.write("../version_name.txt", new_version_name)

    # ---------------------------------------------------------
    # 3. BUILD ARTIFACTS
    # ---------------------------------------------------------

    # Build Store AAB
    gradle(
      task: "bundleStoreRelease",
      properties: {
        "versionCode" => new_version_code
      }
    )

    # DYNAMIC PATH RETRIEVAL
    generated_aab_path = lane_context[SharedValues::GRADLE_AAB_OUTPUT_PATH]

    unless generated_aab_path
      UI.user_error!("âŒ Gradle failed to return an AAB path. Check the build logs.")
    end

    # Build FOSS APK
    gradle(
      task: "copyFossReleaseApk",
      properties: {
        "versionCode" => new_version_code
      }
    )

    # ---------------------------------------------------------
    # 4. UPLOAD TO PLAY STORE
    # ---------------------------------------------------------
    upload_to_play_store(
      track: 'internal',
      release_status: 'completed',
      aab: generated_aab_path,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_apk: true
      # package_name and json_key are inherited from Appfile implicitly
    )
  end
end