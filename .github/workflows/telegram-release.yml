name: Telegram Release

on:
  workflow_dispatch:

jobs:
  build-and-announce:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required to check for releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          cache: 'gradle'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'

      - name: Install Fastlane
        run: gem install fastlane

      # --- SECRET DECODING ---
      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/release.jks

      - name: Decode Google Play Service Account
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}
        run: echo "$PLAY_STORE_JSON_KEY" > app/google-play-api.json

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # --- BUILD ARTIFACTS ---
      - name: Run Fastlane (Build Candidates)
        env:
          JSON_KEY_FILE: ${{ github.workspace }}/app/google-play-api.json
          SUPPLY_JSON_KEY: ${{ github.workspace }}/app/google-play-api.json
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEYSTORE_FILE_PATH: ${{ github.workspace }}/app/release.jks
        run: fastlane android build_release_candidates

      # --- PREPARE ANNOUNCEMENT ---
      - name: Read Version Info
        id: version_info
        run: |
          echo "VERSION_NAME=$(cat version_name.txt)" >> $GITHUB_ENV
          echo "VERSION_CODE=$(cat version_code.txt)" >> $GITHUB_ENV

      - name: Check for GitHub Release
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ env.VERSION_NAME }}"
          echo "Checking for release tag: $TAG"
          
          # Check if release exists using GitHub CLI
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "Release found!"
            echo "release_url=https://github.com/${{ github.repository }}/releases/tag/$TAG" >> $GITHUB_OUTPUT
            echo "has_release=true" >> $GITHUB_OUTPUT
          else
            echo "No release found for $TAG"
            echo "has_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to Telegram Channel
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_RELEASE_CHAT_ID }} # Make sure to set this Secret!
          RELEASE_URL: ${{ steps.check_release.outputs.release_url }}
          HAS_RELEASE: ${{ steps.check_release.outputs.has_release }}
        run: |
          STORE_APK="app/build/distribution/store/store-release.apk"
          FOSS_APK="app/build/distribution/foss/foss-release.apk"
          
          # 1. Construct the Caption
          CAPTION="âš¡ï¸ *Thor v${{ env.VERSION_NAME }} Released!*
          
          Build: ${{ env.VERSION_CODE }}
          Branch: ${{ github.ref_name }}"
          
          if [ "$HAS_RELEASE" = "true" ]; then
            CAPTION="$CAPTION
          
          ðŸ”— [View on GitHub]($RELEASE_URL)"
          fi
          
          # 2. Send Store APK
          echo "Sending Store APK..."
          curl -s -F "chat_id=$TELEGRAM_CHAT_ID" \
               -F "document=@$STORE_APK" \
               -F "caption=$CAPTION" \
               -F "parse_mode=Markdown" \
               "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" > /dev/null

          # 3. Send FOSS APK (Reply to previous? No, just send as second message for now)
          echo "Sending FOSS APK..."
          curl -s -F "chat_id=$TELEGRAM_CHAT_ID" \
               -F "document=@$FOSS_APK" \
               -F "caption=ðŸ”“ *FOSS Version (No Google Services)*" \
               -F "parse_mode=Markdown" \
               "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument" > /dev/null

      # --- SECURITY CLEANUP ---
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f app/release.jks
          rm -f app/google-play-api.json